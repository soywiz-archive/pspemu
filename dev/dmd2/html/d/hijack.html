
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">

<!--
	Copyright (c) 1999-2011 by Digital Mars
	All Rights Reserved Written by Walter Bright
	http://www.digitalmars.com
  -->

<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="keywords" content="D programming language" />
<meta name="description" content="D Programming Language" />
<title>Hijack - D Programming Language 2.0 - Digital Mars</title>
<link rel="stylesheet" type="text/css" href="style.css" />
<link rel="stylesheet" type="text/css" href="print.css" media="print" />
<link rel="shortcut icon" href="favicon.ico" />

<!-- enable this for automated hyphenation, see http://code.google.com/p/hyphenator/ -->
<!--
<script src="http://erdani.com/js/Hyphenator.js" type="text/javascript"></script>
<script type="text/javascript">Hyphenator.run();</script>
-->

</head>

<body class="hyphenate">
<div id="heading">
	<a href="http://www.digitalmars.com/"><img src="dmlogo.gif" width="270" height="53" style="border-style:none" alt="www.digitalmars.com" align="left"></a>
	<p align="right">D Programming Language 2.0</p>
	<br>

	<div id="headingNav">
	<ul>	<li><a href="http://www.digitalmars.com/NewsGroup.html" title="User Forums"><img src="http://www.digitalmars.com/news.png" border=0 alt="User Forums"> Forum</a></li>
	<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?DocComments/Hijack

" title="Read/write comments and feedback"><img src="wiki.png" border=0 alt="D Wiki"> Wiki</a></li>
	<li><a href="index.html" title="D Programming Language" class="dlink">&nbsp;<img src="d.png" border=0 alt="D Programming Language">&nbsp;</a></li>
	<li><a href="http://www.digitalmars.com/advancedsearch.html" title="Search Digital Mars web site"><img src="search.png" border=0 alt="Search">Search</a></li>
	<li><a href="http://www.digitalmars.com/d/download.html" title="download D"><img src="download.png" border=0 alt="Download">Downloads</a></li>
	<li><a href="http://www.digitalmars.com/" title="www.digitalmars.com"><img src="home.png" border=0 alt="digitalmars.com">Home</a></li>
	</ul>
	</div>

	<div id="lastupdate">Last update Fri Jul  8 22:24:15 2011
</div>
</div>
<!-- Generated by Ddoc from hijack.dd -->



<div id="navigation">
  
<div class="navblock">
<form method="get" action="http://www.google.com/search">
<div id="searchbox">
<input id="q" name="q" size="10" value="Search" onFocus='if(this.value == "Search"){this.value="";}'>
<input type="hidden" id="domains" name="domains" value="www.digitalmars.com">
<input type="hidden" id="sitesearch" name="sitesearch" value="www.digitalmars.com/d/2.0">
<input type="hidden" id="sourceid" name="sourceid" value="google-search">
<input type="submit" id="submit" name="submit" value="Go">
</div>
</form>
<div id="toctop">
    <ul>	<li><a href="index.html" title="D Programming Language">D 2.0 Home</a></li>
	<li><a href="spec.html" title="D Language Specification">Language Reference</a></li>
	<li><a href="phobos/phobos.html" title="D Runtime Library">Library Reference</a></li>
	<li><a href="comparison.html" title="Language Comparisons">Comparisons</a></li>
	<li><a href="http://www.digitalmars.com/d/1.0/index.html" title="D Programming Language 1.0">D 1.0 Home</a></li>
    </ul>
</div>
</div>

  
    <div class="navblock">
	<ul>		<li><a href="overview.html" title="D language overview">Overview</a></li>

		<li><a href="windows.html" title="D implementation for 32 bit Windows systems">D for Win32</a></li>

		<li><a href="dll.html" title="Writing 32 bit Windows DLLs in D">Win32 DLLs in D</a></li>

		<li><a href="COM.html" title="Windows COM Programming">COM Programming</a></li>

		<li><a href="htomodule.html" title="converting C .h header files to D modules">C .h to D Modules</a></li>

		<li><a href="faq.html" title="Frequently Asked Questions">FAQ</a></li>

		<li><a href="const-faq.html" title="Frequently Asked Questions about const">const(FAQ)</a></li>

		<li><a href="dstyle.html" title="Recommended programming style conventions">Style Guide</a></li>

		<li><a href="wc.html" title="wc - the wordcount program">Example: wc</a></li>

		<li><a href="future.html" title="Future directions">Future</a></li>

		<li><a href="changelog.html" title="History of changes to D">D Change Log</a></li>

		<li><a href="features2.html" title="Language changes for D 2.0">2.0 Features</a></li>

		<li><a href="http://www.digitalmars.com/techtips/index.html" title="Programming tips">Tech Tips</a></li>

		<li><a href="rationale.html" title="Answers to questions about D design decisions">Rationale</a></li>

		<li><a href="warnings.html" title="Explanation of D compiler generated warning messages">Warnings</a></li>

		<li><a href="http://d.puremagic.com/issues/" title="D issue and bug tracking system">Issues &amp; Bugs</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Articles</h2>
	<ul>		<li><a href="d-floating-point.html" title="D Floating Point">Floating Point</a></li>

		<li><a href="migrate-to-shared.html" title="Migrating to Shared">Migrating to Shared</a></li>

		<li><a href="hijack.html" title="Function Hijacking Mitigation">Hijacking</a></li>

		<li><a href="const3.html" title="Const and Immutable">Const</a></li>

		<li><a href="memory.html" title="Memory management techniques in D">Memory Management</a></li>

		<li><a href="exception-safe.html" title="Exception safe programming techniques">Exception Safety</a></li>

		<li><a href="templates-revisited.html" title="D takes a fresh look at template design">Templates Revisited</a></li>

		<li><a href="regular-expression.html" title="Programming with regular expressions">Regular Expressions</a></li>

		<li><a href="lazy-evaluation.html" title="Lazy evaluation of function arguments">Lazy Evaluation</a></li>

		<li><a href="variadic-function-templates.html" title="Variadic arguments to templates">Variadic Templates</a></li>

		<li><a href="tuple.html" title="What tuples are and how to use them">Tuples</a></li>

		<li><a href="mixin.html" title="String mixins compile string literals into D programs">Mixins</a></li>

		<li><a href="safed.html" title="SafeD - The Safe Subset of D">SafeD</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Slides</h2>
	<ul>		<li><a href="human-error.pdf" title="Patterns of Human Error (pdf)">Patterns of Human Error</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Tools</h2>
	<ul>		<li><a href="dmd-linux.html" title="dmd - the Digital Mars D compiler">DMD D Compiler (Linux)</a></li>

		<li><a href="dmd-freebsd.html" title="dmd - the Digital Mars D compiler">DMD D Compiler (FreeBSD)</a></li>

		<li><a href="dmd-osx.html" title="dmd - the Digital Mars D compiler">DMD D Compiler (Mac OSX)</a></li>

		<li><a href="dmd-windows.html" title="dmd - the Digital Mars D compiler">DMD D Compiler (Windows)</a></li>

		<li><a href="http://bitbucket.org/goshawk/gdc/wiki/Home" title="gdc - the Gnu D compiler">GDC D Compiler</a></li>

		<li><a href="http://www.digitalmars.com/ctg/optlink.html" title="Optlink - the Digital Mars Linker">Linker</a></li>

		<li><a href="http://www.digitalmars.com/ctg/trace.html" title="DMD's builtin code profiling tool">Profiler</a></li>

		<li><a href="code_coverage.html" title="DMD's builtin code coverage analysis tool">Code Coverage</a></li>

		<li><a href="rdmd.html" title="rdmd - run D programs as if they were scripts">DMD Script Shell</a></li>

		<li><a href="windbg.html" title="windbg - debugging Windows programs">Windows Debugger</a></li>

		<li><a href="htod.html" title="htod - mechanically convert C .h header files to D">C .h to D .d</a></li>

		<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?EditorSupport" title="Editors with support for D">Editors</a></li>

		<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?ReferenceForTools" title="Even more tools for D">More Tools</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Forums</h2>
	<ul>		<li><a href="http://www.digitalmars.com/NewsGroup.html" title="User Forums">All Forums</a></li>

		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/index.html.html">digitalmars.D</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/announce/index.html.html">digitalmars.D.announce</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/dwt/index.html.html">digitalmars.D.dwt</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/learn/index.html.html">digitalmars.D.learn</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/bugs/index.html.html">digitalmars.D.bugs</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/debugger/index.html.html">digitalmars.D.debugger</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/ide/index.html.html">digitalmars.D.ide</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/dtl/index.html.html">digitalmars.D.dtl</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/D/gnu/index.html.html">D.gnu</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/index.html.html">Old D</a></li>
	</ul>
    </div>

    <div class="navblock">
	<h2>Community</h2>
	<ul>		<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?FrontPage" title="Wiki for the D Programming Language">Wiki</a></li>

		<li><a href="http://stackoverflow.com/questions/tagged/d" title="D on stackoverflow.com">Stackoverflow</a></li>

		<li><a href="http://twitter.com/#search?q=%23d_lang" title="#d_lang on twitter.com">Twitter</a></li>

		<li><a href="http://www.digitalmars.com/d/dlinks.html" title="External D related links">Links</a></li>

		
		
	</ul>
    </div>

    <div class="navblock">
	<h2>Appendices</h2>
	<ul>		<li><a href="glossary.html" title="D acronyms and jargon explained">Glossary</a></li>

		<li><a href="ascii-table.html" title="Handy ascii chart">Ascii Table</a></li>

		<li><a href="acknowledgements.html" title="Thank-you to these people who have helped with D">Acknowledgements</a></li>

	</ul>
    </div>

    
    <div class="navblock">
	<h2>Books</h2>
	<ul>		<li><a href="http://www.amazon.com/exec/obidos/ASIN/0321635361/classicempire">D Programming Language</a>
</li>
		<li><a href="http://www.amazon.com/exec/obidos/ASIN/1590599608/classicempire">Learn to Tango with D</a>
</li>
		<li><a href="http://www.amazon.com/exec/obidos/ASIN/0596520123/classicempire">Version Control with Git</a>
</li>
	</ul>
    </div>


    
<script src="http://www.gmodules.com/ig/ifr?url=http://www.google.com/ig/modules/translatemypage.xml&up_source_language=en&w=160&h=60&title=&border=&output=js"></script>
    

    <p><center><script src="http://slashdot.org/slashdot-it.js" type="text/javascript"></script></center></p>

</div>
<div id="content">
  <h1>Hijack</h1>
  
<div align="right"><script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script></div>

<p>As software becomes more complex, we become more reliant on module
interfaces. An application may import and combine modules from multiple
sources, including sources from outside the company. The module
developers must be able to maintain and improve those modules without
inadvertently stepping on the behavior of modules over which they cannot
have knowledge of. The application developer needs to be notified if
any module changes would break the application. This talk covers
function hijacking, where adding innocent and reasonable declarations
in a module
can wreak arbitrary havoc on an application program in C++ and Java. We'll then
look at how
modest language design changes can largely eliminate the problem in the D
programming language.
</p>


<h2>Global Function Hijacking</h2>

<p>Let's say we are developing an application that imports two modules:
X from the XXX Corporation, and Y from the YYY Corporation.
Modules X and Y are unrelated to each other, and are used for completely
different purposes.
The modules look like:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> X;

<span class="d_keyword">void</span> foo();
<span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
</span></pre>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> Y;

<span class="d_keyword">void</span> bar();
</span></pre>

<p>The application program would look like:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">import</span> X;
<span class="d_keyword">import</span> Y;

<span class="d_keyword">void</span> abc()
{
    foo(1);  <span class="d_comment">// calls X.foo(long)
</span>}

<span class="d_keyword">void</span> def()
{
    bar();   <span class="d_comment">// calls Y.bar();
</span>}
</span></pre>

<p>So far, so good. The application is tested and works, and is shipped.
Time goes by, the application programmer moves on, the application is
put in maintenance mode. Meanwhile, YYY Corporation, responding to
customer requests, adds a type <tt><span class="notranslate">A</span></tt> and a function <tt><span class="notranslate">foo(A)</span></tt>:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> Y;

<span class="d_keyword">void</span> bar();
<span class="d_keyword">class</span> A;
<span class="d_keyword">void</span> foo(A);
</span></pre>

<p>The application maintainer gets the latest version
of Y, recompiles, and no problems. So far, so good.
But then, YYY Corporation expands the functionality of <tt><span class="notranslate">foo(A)</span></tt>,
adding a function <tt><span class="notranslate">foo(int)</span></tt>:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> Y;

<span class="d_keyword">void</span> bar();
<span class="d_keyword">class</span> A;
<span class="d_keyword">void</span> foo(A);
<span class="d_keyword">void</span> foo(<span class="d_keyword">int</span>);
</span></pre>

<p>Now, our application maintainer routinely gets the latest version of Y,
recompiles, and suddenly his application is doing something unexpected:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">import</span> X;
<span class="d_keyword">import</span> Y;

<span class="d_keyword">void</span> abc()
{
    foo(1);  <span class="d_comment">// calls Y.foo(int) rather than X.foo(long)
</span>}

<span class="d_keyword">void</span> def()
{
    bar();   <span class="d_comment">// calls Y.bar();
</span>}
</span></pre>

<p>because <tt><span class="notranslate">Y.foo(int)</span></tt> is a better overloading match than <tt><span class="notranslate">X.foo(long)</span></tt>.
But since <tt><span class="notranslate">X.foo</span></tt> does something completely and totally different than
<tt><span class="notranslate">Y.foo</span></tt>, the application now has a potentially very serious bug in it.
Even worse, the compiler offers NO indication that this happened and cannot
because, at least for C++, this is how the language is supposed to work.
</p>

<p>In C++, some mitigation can be done by using namespaces or (hopefully)
unique
name prefixes within the modules
X and Y. This doesn't help the application programmer, however, who probably
has no control over X or Y.
</p>

<p>The first stab at fixing this problem in the D programming language was
to add the rules:
</p>

<ol><li>by default functions can only overload against other functions in the same
module</li>
<li>if a name is found in more than one scope, in order to use it it must
be fully qualified</li>
<li>in order to overload functions from multiple modules together, an alias
statement is used to merge the overloads</li>
</ol>

<p>So now, when YYY Corporation added the <tt><span class="notranslate">foo(int)</span></tt> declaration, the
application
maintainer now gets a compilation error that foo is defined in both module
X and module Y, and has an opportunity to fix it.
</p>

<p>This solution worked, but is a little restrictive. After all, there's no
way <tt><span class="notranslate">foo(A)</span></tt> would be confused with <tt><span class="notranslate">foo()</span></tt> or <tt><span class="notranslate">foo(long)</span></tt>,
so why have the compiler
complain about it? The solution turned out to be to introduce the notion
of overload sets.
</p>

<h3>Overload Sets</h3>

<p>An overload set is formed by a group of functions with the same name
declared
in the same scope. In the module X example, the functions <tt><span class="notranslate">X.foo()</span></tt> and
<tt><span class="notranslate">X.foo(long)</span></tt> form a single overload set. The functions
<tt><span class="notranslate">Y.foo(A)</span></tt> and <tt><span class="notranslate">Y.foo(int)</span></tt>
form another overload set. Our method for resolving a call to foo becomes:
</p>

<ol><li>Perform overload resolution independently on each overload set</li>
<li>If there is no match in any overload set, then error</li>
<li>If there is a match in exactly one overload set, then go with that</li>
<li>If there is a match in more than one overload set, then error</li>
</ol>

<p>The most important thing about this is that even if there is a BETTER match
in one overload set over another overload set, it is still an error.
The overload sets must not overlap.
</p>

<p>In our example:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">void</span> abc()
{
    foo(1);  <span class="d_comment">// matches Y.foo(int) exactly, X.foo(long) with conversions
</span>}
</span></pre>

<p>will generate an error, whereas:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">void</span> abc()
{
    A a;
    foo(a);  <span class="d_comment">// matches Y.foo(A) exactly, nothing in X matches
</span>    foo();   <span class="d_comment">// matches X.foo() exactly, nothing in Y matches
</span>}
</span></pre>

<p>compiles without error, as we'd intuitively expect.
</p>

<p>If overloading of <tt><span class="notranslate">foo</span></tt> between X and Y is desired, the following can be done:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">import</span> X;
<span class="d_keyword">import</span> Y;

<span class="d_keyword">alias</span> X.foo foo;
<span class="d_keyword">alias</span> Y.foo foo;

<span class="d_keyword">void</span> abc()
{
    foo(1);  <span class="d_comment">// calls Y.foo(int) rather than X.foo(long)
</span>}
</span></pre>

<p>and no error is generated. The difference here is that the user
deliberately combined the overload sets in X and Y, and so presumably
both knows what he's doing and is willing to check the <tt><span class="notranslate">foo</span></tt>'s when
X or Y is updated.
</p>





<h2>Derived Class Member Function Hijacking</h2>

<p>There are more cases of function hijacking. Imagine a class <tt><span class="notranslate">A</span></tt> coming
from AAA Corporation:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> M;

<span class="d_keyword">class</span> A { }
</span></pre>

<p>and in our application code, we derive from <tt><span class="notranslate">A</span></tt> and add a virtual
member function <tt><span class="notranslate">foo</span></tt>:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">import</span> M;

<span class="d_keyword">class</span> B : A
{
    <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
}

<span class="d_keyword">void</span> abc(B b)
{
    b.foo(1);   <span class="d_comment">// calls B.foo(long)
</span>}
</span></pre>

<p>and everything is hunky-dory. As before, things go on, AAA Corporation
(who cannot know about <tt><span class="notranslate">B</span></tt>) extends <tt><span class="notranslate">A</span></tt>'s functionality a bit by
adding <tt><span class="notranslate">foo(int)</span></tt>:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> M;

<span class="d_keyword">class</span> A
{
    <span class="d_keyword">void</span> foo(<span class="d_keyword">int</span>);
}
</span></pre>

<p>Now, consider if we're using Java-style overloading rules, where base class
member functions overload right alongside derived class functions. Now,
our application call:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">import</span> M;

<span class="d_keyword">class</span> B : A
{
    <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
}

<span class="d_keyword">void</span> abc(B b)
{
    b.foo(1);   <span class="d_comment">// calls A.foo(int), AAAEEEEEIIIII!!!
</span>}
</span></pre>

<p>and the call to <tt><span class="notranslate">B.foo(long)</span></tt> was hijacked by the base class <tt><span class="notranslate">A</span></tt>
to call <tt><span class="notranslate">A.foo(int)</span></tt>,
which likely has no meaning whatsoever in common with <tt><span class="notranslate">B.foo(long)</span></tt>.
This is why I don't like Java overloading rules.
C++ has the right idea here in that functions in a derived class hide
all the functions of the same name in a base class, even if the functions
in the base class might be a better match. D follows this rule.
And once again, if the user desires them to be overloaded against each other,
this can be accomplished in C++ with a using declaration, and in D with
an analogous alias declaration.
</p>




<h2>Base Class Member Function Hijacking</h2>

<p>I bet you suspected there was more to it than that, and you'd be right.
Hijacking can go the other way, too. A derived class can hijack a base
class member function!
</p>

<p>Consider:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> M;

<span class="d_keyword">class</span> A
{
    <span class="d_keyword">void</span> def() { }
}
</span></pre>

<p>and in our application code, we derive from <tt><span class="notranslate">A</span></tt> and add a virtual
member function <tt><span class="notranslate">foo</span></tt>:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">import</span> M;

<span class="d_keyword">class</span> B : A
{
    <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
}

<span class="d_keyword">void</span> abc(B b)
{
    b.def();   <span class="d_comment">// calls A.def()
</span>}
</span></pre>

<p>AAA Corporation once again knows nothing about <tt><span class="notranslate">B</span></tt>, and adds a
function
<tt><span class="notranslate">foo(long)</span></tt> and uses it to implement some needed new functionality of
<tt><span class="notranslate">A</span></tt>:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> M;

<span class="d_keyword">class</span> A
{
    <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);

    <span class="d_keyword">void</span> def()
    {
        foo(1L);   <span class="d_comment">// expects to call A.foo(long)
</span>    }
}
</span></pre>

<p>but, whoops, <tt><span class="notranslate">A.def()</span></tt> now calls <tt><span class="notranslate">B.foo(long)</span></tt>.
<tt><span class="notranslate">B.foo(long)</span></tt> has hijacked
the <tt><span class="notranslate">A.foo(long)</span></tt>. So, you might say, the
designer of A should have had the foresight for this, and make
<tt><span class="notranslate">foo(long)</span></tt> a non-virtual function. The problem is that <tt><span class="notranslate">A</span></tt>'s
designer
may very easily have intended <tt><span class="notranslate">A.foo(long)</span></tt> to be virtual, as it's a new
feature of <tt><span class="notranslate">A</span></tt>. He cannot have known about <tt><span class="notranslate">B.foo(long)</span></tt>.
Take this to the logical conclusion, and we realize that under this system
of overriding, there is no safe way to add any functionality to <tt><span class="notranslate">A</span></tt>.
</p>

<p>The D solution is straightforward. If a function in a derived class
overrides a function in a base class, it must use the storage class
override. If it overrides without using the override storage class
it's an error. If it uses the override storage class without overriding
anything, it's an error.
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">class</span> C
{
    <span class="d_keyword">void</span> foo();
    <span class="d_keyword">void</span> bar();
}
<span class="d_keyword">class</span> D : C
{
    <span class="d_keyword">override</span> <span class="d_keyword">void</span> foo();  <span class="d_comment">// ok
</span>    <span class="d_keyword">void</span> bar();           <span class="d_comment">// error, overrides C.bar()
</span>    <span class="d_keyword">override</span> <span class="d_keyword">void</span> abc();  <span class="d_comment">// error, no C.abc()
</span>}
</span></pre>

<p>This eliminates the potential of a derived class member function hijacking
a base class member function.
</p>




<h2>Derived Class Member Function Hijacking #2</h2>

<p>There's one last case of base member function hijacking a derived
member function. Consider:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> A;

<span class="d_keyword">class</span> A
{
    <span class="d_keyword">void</span> def()
    {
        foo(1);
    }

    <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
}
</span></pre>

<p>Here, <tt><span class="notranslate">foo(long)</span></tt> is a virtual function that provides a specific
functionality.
Our derived class designer overrides <tt><span class="notranslate">foo(long)</span></tt> to replace that behavior
with one suited to the derived class' purpose:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">import</span> A;

<span class="d_keyword">class</span> B : A
{
    <span class="d_keyword">override</span> <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
}

<span class="d_keyword">void</span> abc(B b)
{
    b.def();   <span class="d_comment">// eventually calls B.foo(long)
</span>}
</span></pre>

<p>So far, so good. The call to <tt><span class="notranslate">foo(1)</span></tt> inside <tt><span class="notranslate">A</span></tt>
winds up correctly calling
<tt><span class="notranslate">B.foo(long)</span></tt>. Now <tt><span class="notranslate">A</span></tt>'s designer decides to optimize things, and
adds
an overload for <tt><span class="notranslate">foo</span></tt>:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">module</span> A;

<span class="d_keyword">class</span> A
{
    <span class="d_keyword">void</span> def()
    {
    foo(1);
    }

    <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
    <span class="d_keyword">void</span> foo(<span class="d_keyword">int</span>);
}
</span></pre>

<p>Now,
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">import</span> A;

<span class="d_keyword">class</span> B : A
{
    <span class="d_keyword">override</span> <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
}

<span class="d_keyword">void</span> abc(B b)
{
    b.def();   <span class="d_comment">// eventually calls A.foo(int)
</span>}
</span></pre>

<p>Doh! <tt><span class="notranslate">B</span></tt> thought he was overriding the behavior of <tt><span class="notranslate">A</span></tt>'s
<tt><span class="notranslate">foo</span></tt>, but did not.
<tt><span class="notranslate">B</span></tt>'s programmer needs to add another function to <tt><span class="notranslate">B</span></tt>:
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">class</span> B : A
{
    <span class="d_keyword">override</span> <span class="d_keyword">void</span> foo(<span class="d_keyword">long</span>);
    <span class="d_keyword">override</span> <span class="d_keyword">void</span> foo(<span class="d_keyword">int</span>);
}
</span></pre>

<p>to restore correct behavior. But there's no clue he needs to do that.
Compile time is of no help at all, as the compilation of <tt><span class="notranslate">A</span></tt> has no
knowledge of what <tt><span class="notranslate">B</span></tt> overrides.
</p>

<p>Let's look at how <tt><span class="notranslate">A</span></tt> calls the virtual functions, which it
does through the vtbl[]. <tt><span class="notranslate">A</span></tt>'s vtbl[] looks like:
</p>

<pre class="d_code"><span class="notranslate">A.vtbl[0] = &amp;A.foo(<span class="d_keyword">long</span>);
A.vtbl[1] = &amp;A.foo(<span class="d_keyword">int</span>);
</span></pre>

<p><tt><span class="notranslate">B</span></tt>'s vtbl[] looks like:
</p>

<pre class="d_code"><span class="notranslate">B.vtbl[0] = &amp;B.foo(<span class="d_keyword">long</span>);
B.vtbl[1] = &amp;A.foo(<span class="d_keyword">int</span>);
</span></pre>

<p>and the call in <tt><span class="notranslate">A.def()</span></tt> to <tt><span class="notranslate">foo(int)</span></tt>
is actually a call to vtbl[1].
We'd really like <tt><span class="notranslate">A.foo(int)</span></tt> to be inaccessible from a <tt><span class="notranslate">B</span></tt> object.
The solution is to rewrite <tt><span class="notranslate">B</span></tt>'s vtbl[] as:
</p>

<pre class="d_code"><span class="notranslate">B.vtbl[0] = &amp;B.foo(<span class="d_keyword">long</span>);
B.vtbl[1] = &amp;error;
</span></pre>

<p>where, at runtime, an error function is called which will throw an
exception. It isn't perfect since it isn't caught at compile time,
but at least the application program won't blithely be calling the wrong
function and continue on.
</p>

<p><i>Update: A compile time warning is now generated whenever the
vtbl[] gets an error entry.</i>
</p>



<h2>Conclusion</h2>

<p>Function hijacking is a pernicious and particularly nasty problem in
complex C++ and Java programs because there is no defense against it
for the application programmer. Some small modifications to the language
semantics can defend against it without sacrificing any power or performance.
</p>



<h2>References</h2>

<ul><li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/Hijacking_56458.html">digitalmars.D - Hijacking</a></li>
<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/Re_Hijacking_56505.html">digitalmars.D - Re: Hijacking</a></li>
<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/aliasing_base_methods_49572.html#N49577">digitalmars.D - aliasing base methods</a></li>
<li>Eiffel, Scala and C# use override or something analogous</li>
</ul>

<p>Credits:</p>

<ul><li>Kris Bell</li>
<li>Frank Benoit</li>
<li>Andrei Alexandrescu</li>
</ul>




  
<br><br>
<br><br>
<!-- Google ad -->
<script type="text/javascript"><!--
/**/google_ad_client = "pub-5628673096434613";
/**/google_ad_width = 728;
/**/google_ad_height = 90;
/**/google_ad_format = "728x90_as";
/**/google_ad_channel ="3651639259";
/**/google_page_url = document.location;
//--></script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</div>




<div id="footernav">
<a href="http://www.digitalmars.com/NewsGroup.html" title="User Forums">Forums</a> |
<a href="http://www.prowiki.org/wiki4d/wiki.cgi?DocComments/Hijack

" title="Read/write comments and feedback">Comments</a> |
<a href="index.html" title="D Programming Language" class="dlink">&nbsp;D&nbsp;</a> |
<a href="http://www.digitalmars.com/advancedsearch.html" title="Search Digital Mars web site">Search</a> |
<a href="http://www.digitalmars.com/d/download.html" title="download D">Downloads</a> |
<a href="http://www.digitalmars.com/" title="www.digitalmars.com">Home</a>
</div>
<div id="copyright">

Copyright &copy; 1999-2011 by Digital Mars &reg;, All Rights Reserved
 |
Page generated by <a href="http://www.digitalmars.com/d/2.0/ddoc.html">Ddoc</a>.
</div>


<script src="http://completelyexpendable.info/editable_code.js"></script>
</body>
</html>

